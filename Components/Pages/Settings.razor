@page "/settings"
@using BrainDumpster.Services
@using BrainDumpster.Model
@inject SettingsService SettingsService
@inject IJSRuntime JS
@inject NavigationManager Nav

<div class="settings-page">
    <h1>Settings</h1>

    @if (user != null)
    {
        <div class="settings-container">
            <!-- User Info -->
            <div class="card">
                <h3>👤 Profile</h3>
                <p><strong>Username:</strong> @user.Username</p>
                <button @onclick="ShowUsernameModal" class="btn">Change Username</button>
                <br />
                <button @onclick="ShowPinModal" class="btn">Change PIN</button>
            </div>

            <!-- Stats -->
            <div class="card">
                <h3>📊 Stats</h3>
                <p><strong>Total Entries:</strong> @totalEntries</p>
                <p><strong>Current Streak:</strong> @currentStreak days</p>
                <button @onclick="ShowExportModal" class="btn">Export Journals as PDF</button>
            </div>

            <!-- Theme -->
            <div class="card">
                <h3>🎨 Theme</h3>
                <button @onclick="ToggleTheme" class="btn">
                    @if (isDarkMode)
                    {
                        <span>🌙 Dark Mode</span>
                    }
                    else
                    {
                        <span>☀️ Light Mode</span>
                    }
                </button>
            </div>

            <!-- Logout -->
            <div class="card">
                <h3>🔓 Account</h3>
                <button @onclick="Logout" class="btn btn-danger">Logout</button>
            </div>
        </div>

        <!-- Username Modal -->
        @if (showUsernameModal)
        {
            <div class="modal">
                <div class="modal-content">
                    <h3>Change Username</h3>
                    <p>Current: <strong>@user.Username</strong></p>
                    <input type="text" @bind="newUsername" placeholder="New username" class="form-control" />
                    <br />
                    @if (!string.IsNullOrEmpty(message))
                    {
                        <div class="alert @(isError ? "alert-danger" : "alert-success")">
                            @message
                        </div>
                    }
                    <div class="modal-actions">
                        <button @onclick="CloseModal" class="btn">Cancel</button>
                        <button @onclick="SaveUsername" class="btn btn-primary" disabled="@isSaving">
                            @if (isSaving)
                            {
                                <span>Saving...</span>
                            }
                            else
                            {
                                <span>Save</span>
                            }
                        </button>
                    </div>
                </div>
            </div>
        }

        <!-- PIN Modal -->
        @if (showPinModal)
        {
            <div class="modal">
                <div class="modal-content">
                    <h3>Change PIN</h3>
                    <input type="password" @bind="currentPin" placeholder="Current PIN" class="form-control" />
                    <br />
                    <input type="password" @bind="newPin" placeholder="New PIN (4-6 digits)" maxlength="6" class="form-control" />
                    <br />
                    <input type="password" @bind="confirmPin" placeholder="Confirm New PIN" maxlength="6" class="form-control" />
                    <br />
                    @if (!string.IsNullOrEmpty(message))
                    {
                        <div class="alert @(isError ? "alert-danger" : "alert-success")">
                            @message
                        </div>
                    }
                    <div class="modal-actions">
                        <button @onclick="CloseModal" class="btn">Cancel</button>
                        <button @onclick="SavePin" class="btn btn-primary" disabled="@isSaving">
                            @if (isSaving)
                            {
                                <span>Saving...</span>
                            }
                            else
                            {
                                <span>Change PIN</span>
                            }
                        </button>
                    </div>
                </div>
            </div>
        }

        <!-- Export Modal -->
        @if (showExportModal)
        {
            <div class="modal">
                <div class="modal-content">
                    <h3>📤 Export Journals as PDF</h3>

                    <div class="export-options">
                        <button @onclick="SetExportTypeAll" class="@(exportType == "all" ? "export-btn-active" : "export-btn")">
                            📄 All Journals
                        </button>
                        <button @onclick="SetExportTypeDate" class="@(exportType == "date" ? "export-btn-active" : "export-btn")">
                            📅 Specific Date
                        </button>
                        <button @onclick="SetExportTypeRange" class="@(exportType == "range" ? "export-btn-active" : "export-btn")">
                            📆 Date Range
                        </button>
                    </div>

                    @if (exportType == "date")
                    {
                        <div>
                            <label>Select Date:</label>
                            <input type="date" @bind="selectedDate" @bind:format="yyyy-MM-dd" class="form-control" />
                        </div>
                    }

                    @if (exportType == "range")
                    {
                        <div>
                            <label>Start Date:</label>
                            <input type="date" @bind="startDate" @bind:format="yyyy-MM-dd" class="form-control" />
                            <br />
                            <label>End Date:</label>
                            <input type="date" @bind="endDate" @bind:format="yyyy-MM-dd" class="form-control" />
                        </div>
                    }

                    @if (!string.IsNullOrEmpty(message))
                    {
                        <div class="alert @(isError ? "alert-danger" : "alert-success")">
                            @message
                        </div>
                    }

                    <div class="modal-actions">
                        <button @onclick="CloseModal" class="btn">Cancel</button>
                        <button @onclick="ExportPdf" class="btn btn-primary" disabled="@isSaving">
                            @if (isSaving)
                            {
                                <span>Generating PDF...</span>
                            }
                            else
                            {
                                <span>Download PDF</span>
                            }
                        </button>
                    </div>
                </div>
            </div>
        }
    }
    else
    {
        <p>Please <a href="/login">login</a> to view settings.</p>
    }
</div>

<style>
    /* General page styling */
    .settings-page {
        max-width: 900px;
        margin: 2rem auto;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        padding: 0 1rem;
    }

    .settings-page h1 {
        text-align: center;
        margin-bottom: 2rem;
        font-size: 2.2rem;
    }

    /* Container for cards */
    .settings-container {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 1.5rem;
    }

    /* Card styling */
    .card {
        background-color: #ffffff;
        padding: 1.5rem;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        transition: transform 0.2s, box-shadow 0.2s;
    }

    .card:hover {
        transform: translateY(-3px);
        box-shadow: 0 6px 18px rgba(0, 0, 0, 0.15);
    }

    .card h3 {
        margin-bottom: 1rem;
        font-size: 1.3rem;
    }

    /* Buttons */
    .btn {
        padding: 0.5rem 1.2rem;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-weight: 500;
        transition: all 0.2s;
        margin-top: 0.5rem;
        background-color: #4a90e2;
        color: #fff;
    }

    .btn:hover {
        background-color: #357ab7;
    }

    .btn-danger {
        background-color: #e74c3c;
    }

    .btn-danger:hover {
        background-color: #c0392b;
    }

    .btn-primary {
        background-color: #27ae60;
    }

    .btn-primary:hover {
        background-color: #1e8449;
    }

    /* Modal styling */
    .modal {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: rgba(0, 0, 0, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 999;
    }

    .modal-content {
        background-color: #fff;
        padding: 2rem;
        border-radius: 12px;
        max-width: 500px;
        width: 90%;
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.25);
        position: relative;
    }

    .modal-content h3 {
        margin-top: 0;
    }

    /* Form inputs */
    .form-control {
        width: 100%;
        padding: 0.6rem 0.8rem;
        border: 1px solid #ccc;
        border-radius: 6px;
        margin-bottom: 0.8rem;
        font-size: 1rem;
    }

    .form-control:focus {
        outline: none;
        border-color: #4a90e2;
        box-shadow: 0 0 4px rgba(74, 144, 226, 0.5);
    }

    /* Alerts */
    .alert {
        padding: 0.5rem 0.8rem;
        border-radius: 6px;
        margin: 0.5rem 0;
    }

    .alert-success {
        background-color: #d4edda;
        color: #155724;
    }

    .alert-danger {
        background-color: #f8d7da;
        color: #721c24;
    }

    /* Export modal buttons */
    .export-options {
        display: flex;
        gap: 0.5rem;
        margin-bottom: 1rem;
    }

    .export-btn, .export-btn-active {
        flex: 1;
        padding: 0.5rem 0;
        border-radius: 6px;
        border: 1px solid #ccc;
        cursor: pointer;
        text-align: center;
        transition: all 0.2s;
    }

    .export-btn {
        background-color: #f0f0f0;
    }

    .export-btn:hover {
        background-color: #e0e0e0;
    }

    .export-btn-active {
        background-color: #4a90e2;
        color: #fff;
        border-color: #357ab7;
    }

    
    .modal-actions {
        display: flex;
        justify-content: flex-end;
        gap: 0.5rem;
        margin-top: 1rem;
    }

    /* Dark mode */
    body.dark-mode {
        background-color: #1a1a1a;
        color: #f1f1f1;
    }

    body.dark-mode .card,
    body.dark-mode .modal-content {
        background-color: #2a2a2a;
    }

    body.dark-mode .form-control {
        background-color: #3a3a3a;
        color: #fff;
        border: 1px solid #555;
    }

    body.dark-mode .btn {
        color: #fff;
    }

    body.dark-mode .alert-success {
        background-color: #1557241a;
        color: #d4edda;
    }

    body.dark-mode .alert-danger {
        background-color: #721c241a;
        color: #f8d7da;
    }
</style>


@code {
    private User? user = null;
    private int loggedUserId = 0;
    private int totalEntries = 0;
    private int currentStreak = 0;

    private bool showUsernameModal = false;
    private bool showPinModal = false;
    private bool showExportModal = false;
    private string newUsername = "";
    private string currentPin = "";
    private string newPin = "";
    private string confirmPin = "";
    private string message = "";
    private bool isError = false;
    private bool isSaving = false;

    private string exportType = "all";
    private DateTime selectedDate = DateTime.Today;
    private DateTime startDate = DateTime.Today.AddDays(-7);
    private DateTime endDate = DateTime.Today;

    private bool isDarkMode = false;

    protected override async Task OnInitializedAsync()
    {
        var userIdStr = await JS.InvokeAsync<string>("localStorage.getItem", "loggedUserId");
        if (!string.IsNullOrEmpty(userIdStr) && int.TryParse(userIdStr, out loggedUserId))
        {
            await LoadUserData();
            await LoadTheme();
        }
        else
        {
            Nav.NavigateTo("/login");
        }
    }

    private async Task LoadUserData()
    {
        try
        {
            user = await SettingsService.GetUserAsync(loggedUserId);
            if (user == null)
            {
                await Logout();
                return;
            }

            var stats = await SettingsService.GetUserStatsAsync(loggedUserId);
            totalEntries = stats.TotalEntries;
            currentStreak = stats.Streak;
        }
        catch (Exception ex)
        {
            message = $"Error: {ex.Message}";
            isError = true;
        }
    }

    private async Task LoadTheme()
    {
        try
        {
            var theme = await JS.InvokeAsync<string>("localStorage.getItem", "theme");
            isDarkMode = theme == "dark";

            if (isDarkMode)
            {
                await JS.InvokeVoidAsync("eval", "document.body.style.backgroundColor = '#1a1a1a'; document.body.style.color = '#ffffff';");
            }
        }
        catch
        {
            isDarkMode = false;
        }
    }

    private async Task ToggleTheme()
    {
        isDarkMode = !isDarkMode;

        try
        {
            await JS.InvokeVoidAsync("localStorage.setItem", "theme", isDarkMode ? "dark" : "light");

            if (isDarkMode)
            {
                await JS.InvokeVoidAsync("eval", "document.body.style.backgroundColor = '#1a1a1a'; document.body.style.color = '#ffffff';");
            }
            else
            {
                await JS.InvokeVoidAsync("eval", "document.body.style.backgroundColor = '#ffffff'; document.body.style.color = '#000000';");
            }

            StateHasChanged();
        }
        catch (Exception ex)
        {
            message = $"Theme error: {ex.Message}";
            isError = true;
            StateHasChanged();
        }
    }

    private void ShowUsernameModal()
    {
        showUsernameModal = true;
        showPinModal = false;
        showExportModal = false;
        newUsername = user?.Username ?? "";
        message = "";
        isError = false;
        StateHasChanged();
    }

    private void ShowPinModal()
    {
        showPinModal = true;
        showUsernameModal = false;
        showExportModal = false;
        currentPin = "";
        newPin = "";
        confirmPin = "";
        message = "";
        isError = false;
        StateHasChanged();
    }

    private void ShowExportModal()
    {
        showExportModal = true;
        showUsernameModal = false;
        showPinModal = false;
        exportType = "all";
        message = "";
        isError = false;
        StateHasChanged();
    }

    private void CloseModal()
    {
        showUsernameModal = false;
        showPinModal = false;
        showExportModal = false;
        message = "";
        isError = false;
        isSaving = false;
        StateHasChanged();
    }

    private void SetExportTypeAll()
    {
        exportType = "all";
        StateHasChanged();
    }

    private void SetExportTypeDate()
    {
        exportType = "date";
        StateHasChanged();
    }

    private void SetExportTypeRange()
    {
        exportType = "range";
        StateHasChanged();
    }

    private async Task SaveUsername()
    {
        if (string.IsNullOrWhiteSpace(newUsername) || user == null)
            return;

        isSaving = true;
        StateHasChanged();

        var result = await SettingsService.UpdateUsernameAsync(loggedUserId, newUsername);

        message = result.Message;
        isError = !result.Success;

        if (result.Success)
        {
            await LoadUserData();
            await Task.Delay(1500);
            CloseModal();
        }

        isSaving = false;
        StateHasChanged();
    }

    private async Task SavePin()
    {
        if (user == null)
            return;

        if (newPin != confirmPin)
        {
            message = "PINs don't match";
            isError = true;
            StateHasChanged();
            return;
        }

        isSaving = true;
        StateHasChanged();

        var result = await SettingsService.UpdatePinAsync(loggedUserId, currentPin, newPin);

        message = result.Message;
        isError = !result.Success;

        if (result.Success)
        {
            await Task.Delay(1500);
            CloseModal();
        }

        isSaving = false;
        StateHasChanged();
    }

    private async Task ExportPdf()
    {
        try
        {
            isSaving = true;
            message = "Generating PDF...";
            isError = false;
            StateHasChanged();

            (bool Success, string Message, byte[]? PdfData) result;
            string fileName = "";

            if (exportType == "date")
            {
                result = await SettingsService.ExportPdfByDateAsync(loggedUserId, selectedDate);
                fileName = $"BrainDumpster_{selectedDate:yyyyMMdd}.pdf";
            }
            else if (exportType == "range")
            {
                result = await SettingsService.ExportPdfByDateRangeAsync(loggedUserId, startDate, endDate);
                fileName = $"BrainDumpster_{startDate:yyyyMMdd}_to_{endDate:yyyyMMdd}.pdf";
            }
            else
            {
                result = await SettingsService.ExportPdfAllAsync(loggedUserId);
                fileName = $"BrainDumpster_All_Journals_{DateTime.Now:yyyyMMdd_HHmmss}.pdf";
            }

            if (!result.Success || result.PdfData == null)
            {
                message = result.Message;
                isError = true;
                isSaving = false;
                StateHasChanged();
                return;
            }

            try
            {
                await SettingsService.DownloadPdfFile(result.PdfData, fileName);
                message = $"✅ PDF downloaded: {fileName}";
                isError = false;

                await Task.Delay(1500);
                CloseModal();
            }
            catch (Exception ex)
            {
                var base64 = Convert.ToBase64String(result.PdfData);
                await JS.InvokeVoidAsync("downloadPdf", base64, fileName);

                message = $"✅ PDF downloaded: {fileName}";
                isError = false;

                await Task.Delay(1500);
                CloseModal();
            }
        }
        catch (Exception ex)
        {
            message = $"❌ PDF export failed: {ex.Message}";
            isError = true;
        }
        finally
        {
            isSaving = false;
            StateHasChanged();
        }
    }

    private async Task Logout()
    {
        await JS.InvokeVoidAsync("localStorage.removeItem", "loggedUserId");
        Nav.NavigateTo("/", true);
    }
}