@page "/dashboard"
@using BrainDumpster.Data
@using BrainDumpster.Model
@inject AppDbContext db
@inject IJSRuntime JS
@inject NavigationManager Nav

<PageTitle>Dashboard - BrainDumpster</PageTitle>

<div class="dashboard-container">
    <!-- Header -->
    <div class="dashboard-header">
        <h1>Welcome Back! 👋</h1>
        <p class="date-display">@DateTime.Now.ToString("dddd, MMMM d, yyyy")</p>
    </div>

    <!-- Stats Cards -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-icon">📅</div>
            <div class="stat-content">
                <h3>@totalEntries</h3>
                <p>Total Entries</p>
            </div>
        </div>

        <div class="stat-card streak-card">
            <div class="stat-icon">🔥</div>
            <div class="stat-content">
                <h3>@currentStreak</h3>
                <p>Day Streak</p>
                <small>Best: @longestStreak</small>
            </div>
        </div>

        <div class="stat-card">
            <div class="stat-icon">😊</div>
            <div class="stat-content">
                <h3>@averageMood</h3>
                <p>Avg Mood</p>
            </div>
        </div>
    </div>

    <!-- Today's Entry -->
    <div class="section today-section">
        <div class="section-title">
            <h2>📝 Today's Journal</h2>
            <button @onclick="GoToJournal" class="btn-primary">
                @(hasTodayEntry ? "Edit Entry" : "Write Now")
            </button>
        </div>

        @if (hasTodayEntry && todayEntry != null)
        {
            <div class="today-card">
                <div class="today-mood">@todayEntry.PrimaryMood</div>
                <div class="today-preview">
                    @((MarkupString)GetPreview(todayEntry.Content))
                </div>
                <div class="today-time">@todayEntry.EntryDate.ToString("h:mm tt")</div>
            </div>
        }
        else
        {
            <div class="empty-state">
                <p>No entry for today yet.</p>
                <p class="hint">Write to keep your streak going! 🔥</p>
            </div>
        }
    </div>

    <!-- Week Overview -->
    <div class="section week-section">
        <h2>📅 This Week</h2>
        <div class="week-grid">
            @foreach (var day in weekDays)
            {
                <div class="day-cell @(day.HasEntry ? "has-entry" : "") @(day.IsToday ? "today" : "")">
                    <div class="day-name">@day.DayName</div>
                    <div class="day-date">@day.Date</div>
                    @if (day.HasEntry)
                    {
                        <div class="day-mood">@day.Mood</div>
                    }
                </div>
            }
        </div>
    </div>

    <!-- Recent Entries -->
    <div class="section recent-section">
        <div class="section-title">
            <h2>⏳ Recent Entries</h2>
            <a href="/timeline" class="view-all">View All</a>
        </div>

        @if (recentEntries.Any())
        {
            <div class="recent-list">
                @foreach (var entry in recentEntries)
                {
                    <div class="recent-item">
                        <div class="recent-date">@entry.EntryDate.ToString("MMM d")</div>
                        <div class="recent-mood">@entry.PrimaryMood</div>
                        <div class="recent-preview">@GetShortPreview(entry.Content)</div>
                    </div>
                }
            </div>
        }
        else
        {
            <div class="empty-state">
                <p>No recent entries</p>
            </div>
        }
    </div>

    <!-- Quick Actions -->
    <div class="section actions-section">
        <h2>⚡ Quick Actions</h2>
        <div class="actions-grid">
            <button @onclick="GoToJournal" class="action-btn">
                <span>📝</span>
                <span>Journal</span>
            </button>
            <button @onclick="GoToCalendar" class="action-btn">
                <span>📅</span>
                <span>Calendar</span>
            </button>
            <button @onclick="GoToTimeline" class="action-btn">
                <span>⏳</span>
                <span>Timeline</span>
            </button>
        </div>
    </div>
</div>

<style>
    
</style>

@code {
    // Data variables
    private int loggedUserId = 0;
    private int totalEntries = 0;
    private int currentStreak = 0;
    private int longestStreak = 0;
    private string averageMood = "🙂";

    // Entry variables
    private JournalEntry? todayEntry = null;
    private bool hasTodayEntry = false;
    private List<JournalEntry> recentEntries = new();
    private List<WeekDay> weekDays = new();

    // Helper class for week days
    private class WeekDay
    {
        public string DayName { get; set; } = "";
        public string Date { get; set; } = "";
        public bool HasEntry { get; set; }
        public string Mood { get; set; } = "";
        public bool IsToday { get; set; }
    }

    protected override async Task OnInitializedAsync()
    {
        // Get logged user ID from localStorage
        var userIdStr = await JS.InvokeAsync<string>("localStorage.getItem", "loggedUserId");
        if (!string.IsNullOrEmpty(userIdStr))
        {
            loggedUserId = int.Parse(userIdStr);
            await LoadDashboardData();
        }
        else
        {
            // Redirect to login if not logged in
            Nav.NavigateTo("/login");
        }
    }

    private async Task LoadDashboardData()
    {
        try
        {
            // Load all entries for this user
            var allEntries = await Task.Run(() =>
                db.JournalEntries
                    .Where(e => e.UserId == loggedUserId)
                    .OrderByDescending(e => e.EntryDate)
                    .ToList());

            // Basic stats
            totalEntries = allEntries.Count;

            // Today's entry
            todayEntry = allEntries.FirstOrDefault(e => e.EntryDate.Date == DateTime.Today);
            hasTodayEntry = todayEntry != null;

            // Recent entries (last 5, excluding today)
            recentEntries = allEntries
                .Where(e => e.EntryDate.Date != DateTime.Today)
                .Take(5)
                .ToList();

            // Calculate streaks DYNAMICALLY
            CalculateStreaks(allEntries);

            // Calculate average mood
            CalculateAverageMood(allEntries);

            // Generate week view
            GenerateWeekView(allEntries);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading dashboard: {ex.Message}");
            // Don't crash - just show empty state
        }
    }

    private void CalculateStreaks(List<JournalEntry> entries)
    {
        if (entries == null || !entries.Any())
        {
            currentStreak = 0;
            longestStreak = 0;
            return;
        }

        try
        {
            // Get all unique dates with entries
            var entryDates = entries
                .Select(e => e.EntryDate.Date)
                .Distinct()
                .OrderByDescending(d => d)
                .ToList();

            // Calculate current streak
            int streak = 0;
            var checkDate = DateTime.Today;

            // Check if today has an entry
            if (entryDates.Contains(DateTime.Today))
            {
                streak = 1;
                checkDate = DateTime.Today.AddDays(-1);

                // Count backwards while we have consecutive entries
                while (entryDates.Contains(checkDate))
                {
                    streak++;
                    checkDate = checkDate.AddDays(-1);
                }
            }
            else
            {
                // Check yesterday
                checkDate = DateTime.Today.AddDays(-1);
                if (entryDates.Contains(checkDate))
                {
                    streak = 1;
                    checkDate = checkDate.AddDays(-1);

                    while (entryDates.Contains(checkDate))
                    {
                        streak++;
                        checkDate = checkDate.AddDays(-1);
                    }
                }
            }

            currentStreak = streak;

            // Calculate longest streak
            longestStreak = FindLongestStreak(entryDates);
        }
        catch
        {
            currentStreak = 0;
            longestStreak = 0;
        }
    }

    private int FindLongestStreak(List<DateTime> dates)
    {
        if (dates == null || !dates.Any()) return 0;

        var sortedDates = dates.OrderBy(d => d).ToList();
        int longest = 1;
        int current = 1;

        for (int i = 1; i < sortedDates.Count; i++)
        {
            var diff = (sortedDates[i] - sortedDates[i - 1]).Days;

            if (diff == 1)
            {
                current++;
                if (current > longest) longest = current;
            }
            else if (diff > 1)
            {
                current = 1;
            }
        }

        return longest;
    }

    private void CalculateAverageMood(List<JournalEntry> entries)
    {
        if (entries == null || !entries.Any())
        {
            averageMood = "🙂";
            return;
        }

        try
        {
            // Simple mood scoring
            var moodCounts = new Dictionary<string, int>
            {
                ["😄"] = 0,
                ["🙂"] = 0,
                ["😐"] = 0,
                ["😔"] = 0,
                ["😢"] = 0
            };

            foreach (var entry in entries)
            {
                if (moodCounts.ContainsKey(entry.PrimaryMood))
                {
                    moodCounts[entry.PrimaryMood]++;
                }
            }

            // Find most common mood
            var mostCommon = moodCounts
                .OrderByDescending(kv => kv.Value)
                .FirstOrDefault();

            averageMood = mostCommon.Key ?? "🙂";
        }
        catch
        {
            averageMood = "🙂";
        }
    }

    private void GenerateWeekView(List<JournalEntry> entries)
    {
        weekDays.Clear();

        // Get last 7 days including today
        for (int i = 6; i >= 0; i--)
        {
            var date = DateTime.Today.AddDays(-i);
            var entry = entries?.FirstOrDefault(e => e.EntryDate.Date == date.Date);

            weekDays.Add(new WeekDay
            {
                DayName = date.ToString("ddd"),
                Date = date.Day.ToString(),
                HasEntry = entry != null,
                Mood = entry?.PrimaryMood ?? "",
                IsToday = date.Date == DateTime.Today.Date
            });
        }
    }

    private string GetPreview(string content)
    {
        if (string.IsNullOrEmpty(content)) return "";

        try
        {
            // Remove HTML tags
            var plainText = System.Text.RegularExpressions.Regex.Replace(content, "<.*?>", " ");

            // Limit length
            if (plainText.Length > 150)
                return plainText.Substring(0, 150) + "...";

            return plainText;
        }
        catch
        {
            return "";
        }
    }

    private string GetShortPreview(string content)
    {
        if (string.IsNullOrEmpty(content)) return "";

        try
        {
            var plainText = System.Text.RegularExpressions.Regex.Replace(content, "<.*?>", " ");

            if (plainText.Length > 60)
                return plainText.Substring(0, 60) + "...";

            return plainText;
        }
        catch
        {
            return "";
        }
    }

    // Navigation methods
    private void GoToJournal()
    {
        Nav.NavigateTo("/entry");
    }

    private void GoToCalendar()
    {
        Nav.NavigateTo("/calendar");
    }

    private void GoToTimeline()
    {
        Nav.NavigateTo("/timeline");
    }
}