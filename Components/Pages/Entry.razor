@page "/entry"
@using BrainDumpster.Model
@using BrainDumpster.Services
@inject JournalService JournalService
@inject NavigationManager Nav

<h1>New Journal Entry</h1>

@if (loggedUserId > 0)
{
    <div>
        <!-- Editor -->
        <div class="mb-3">
            <label class="form-label">Content</label>
            <div id="editor" style="height: 200px;"></div>
        </div>

        <!-- Mood Selection -->
        <div class="mb-3">
            <label class="form-label">Mood</label>
            <div>
                @foreach (var m in moods)
                {
                    <button class="btn @(mood == m ? "btn-primary" : "btn-outline-primary") me-2"
                            @onclick="() => mood = m">
                        @m
                    </button>
                }
            </div>
        </div>

        <!-- Tags -->
        <div class="mb-3">
            <label class="form-label">Tags</label>
            <div>
                @foreach (var t in availableTags)
                {
                    <button class="btn btn-sm @(selectedTags.Contains(t) ? "btn-primary" : "btn-outline-secondary") me-2 mb-2"
                            @onclick="() => ToggleTag(t)">
                        @t
                    </button>
                }
            </div>
        </div>

        <!-- Save Button -->
        <button class="btn btn-success" @onclick="SaveEntry">
            Save Entry
        </button>

        <!-- Message -->
        @if (!string.IsNullOrEmpty(message))
        {
            <div class="alert @(isError ? "alert-danger" : "alert-success") mt-3">
                @message
            </div>
        }

        <!-- Recent Entries -->
        <h2 class="mt-5">Recent Entries</h2>
        @if (entries.Any())
        {
            @foreach (var e in entries.Take(5))
            {
                <div class="card mb-3">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <small>@e.EntryDate.ToString("MMMM dd, yyyy h:mm tt") - @e.PrimaryMood</small>

                        <div>
                            <button class="btn btn-sm btn-primary me-2"
                                    @onclick="() => EditEntry(e.Id)">
                                Edit
                            </button>

                            <button class="btn btn-sm btn-danger"
                                    @onclick="() => DeleteEntry(e.Id)">
                                Delete
                            </button>
                        </div>
                    </div>
                </div>

            }
        }
    </div>
}
else
{
    <div class="alert alert-warning">
        Please log in to view your journal.
        <button class="btn btn-sm btn-outline-warning ms-2" @onclick="GoToLogin">Login</button>
    </div>
}

@code {
    private string mood = "🙂";
    private List<string> selectedTags = new();
    private List<JournalEntry> entries = new();
    private string message = "";
    private bool isError = false;
    private int loggedUserId = 0;

    private readonly List<string> moods = new() { "😄", "🙂", "😐", "😔" };
    private readonly List<string> availableTags = new() { "Work", "Health", "Fitness", "Study", "Travel", "Personal", "Reflection", "Planning" };

    protected override async Task OnInitializedAsync()
    {
        var userId = await JournalService.GetLoggedUserIdAsync();
        if (userId.HasValue)
        {
            loggedUserId = userId.Value;
            LoadEntries();
        }
        else
        {
            Nav.NavigateTo("/login");
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && loggedUserId > 0)
        {
            await JournalService.InitEditor();
        }
    }

    private void ToggleTag(string tag)
    {
        if (selectedTags.Contains(tag))
            selectedTags.Remove(tag);
        else
            selectedTags.Add(tag);
    }

    private void LoadEntries()
    {
        entries = JournalService.GetEntries(loggedUserId);
    }

    private async Task SaveEntry()
    {
        var content = await JournalService.GetEditorContent();

        var result = await JournalService.SaveEntryOncePerDayAsync(
            loggedUserId, content, mood, selectedTags);

        message = result.Message;
        isError = !result.Success;

        if (result.Success)
        {
            await JournalService.ClearEditor();
            selectedTags.Clear();
            mood = "🙂";
            LoadEntries();
        }
    }


    private void EditEntry(int entryId)
    {
        Nav.NavigateTo($"/entry/edit/{entryId}");
    }

    private async Task DeleteEntry(int entryId)
    {
        await JournalService.DeleteEntryAsync(entryId, loggedUserId);
        LoadEntries();
    }


    private void GoToLogin()
    {
        Nav.NavigateTo("/login");
    }
}