@page "/dashboard"
@using BrainDumpster.Data
@using BrainDumpster.Model
@inject AppDbContext db
@inject IJSRuntime JS
@inject NavigationManager Nav

<PageTitle>Dashboard - BrainDumpster</PageTitle>

<div class="dashboard-container">
    <!-- Header -->
    <div class="dashboard-header">
        <h1>Welcome Back! 👋</h1>
        <p class="date-display">@DateTime.Now.ToString("dddd, MMMM d, yyyy")</p>
    </div>

    <!-- Stats Cards -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-icon">📅</div>
            <div class="stat-content">
                <h3>@totalEntries</h3>
                <p>Total Entries</p>
            </div>
        </div>

        <div class="stat-card streak-card">
            <div class="stat-icon">🔥</div>
            <div class="stat-content">
                <h3>@currentStreak</h3>
                <p>Day Streak</p>
                <small>Best: @longestStreak</small>
            </div>
        </div>

        <div class="stat-card">
            <div class="stat-icon">😊</div>
            <div class="stat-content">
                <h3>@averageMood</h3>
                <p>Avg Mood</p>
            </div>
        </div>
    </div>

    <!-- Today's Entry -->
    <div class="section today-section">
        <div class="section-title">
            <h2>📝 Today's Journal</h2>
            <button @onclick="GoToJournal" class="btn-primary">
                @(hasTodayEntry ? "Edit Entry" : "Write Now")
            </button>
        </div>

        @if (hasTodayEntry && todayEntry != null)
        {
            <div class="today-card">
                <div class="today-mood">@todayEntry.PrimaryMood</div>
                <div class="today-preview">
                    @((MarkupString)GetPreview(todayEntry.Content))
                </div>
                <div class="today-time">@todayEntry.EntryDate.ToString("h:mm tt")</div>
            </div>
        }
        else
        {
            <div class="empty-state">
                <p>No entry for today yet.</p>
                <p class="hint">Write to keep your streak going! 🔥</p>
            </div>
        }
    </div>

    <!-- Week Overview -->
    <div class="section week-section">
        <h2>📅 This Week</h2>
        <div class="week-grid">
            @foreach (var day in weekDays)
            {
                <div class="day-cell @(day.HasEntry ? "has-entry" : "") @(day.IsToday ? "today" : "")">
                    <div class="day-name">@day.DayName</div>
                    <div class="day-date">@day.Date</div>
                    @if (day.HasEntry)
                    {
                        <div class="day-mood">@day.Mood</div>
                    }
                </div>
            }
        </div>
    </div>

    <!-- Recent Entries -->
    <div class="section recent-section">
        <div class="section-title">
            <h2>⏳ Recent Entries</h2>
            <a href="/timeline" class="view-all">View All</a>
        </div>

        @if (recentEntries.Any())
        {
            <div class="recent-list">
                @foreach (var entry in recentEntries)
                {
                    <div class="recent-item">
                        <div class="recent-date">@entry.EntryDate.ToString("MMM d")</div>
                        <div class="recent-mood">@entry.PrimaryMood</div>
                        <div class="recent-preview">@GetShortPreview(entry.Content)</div>
                    </div>
                }
            </div>
        }
        else
        {
            <div class="empty-state">
                <p>No recent entries</p>
            </div>
        }
    </div>

    <!-- Quick Actions -->
    <div class="section actions-section">
        <h2>⚡ Quick Actions</h2>
        <div class="actions-grid">
            <button @onclick="GoToJournal" class="action-btn">
                <span>📝</span>
                <span>Journal</span>
            </button>
            <button @onclick="GoToCalendar" class="action-btn">
                <span>📅</span>
                <span>Calendar</span>
            </button>
            <button @onclick="GoToTimeline" class="action-btn">
                <span>⏳</span>
                <span>Timeline</span>
            </button>
        </div>
    </div>
</div>

<style>
    /* Reset and base styles */
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }

    .dashboard-container {
        padding: 20px;
        max-width: 1200px;
        margin: 0 auto;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    }

    .dashboard-header {
        text-align: center;
        margin-bottom: 30px;
        padding: 20px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 15px;
        color: white;
    }

        .dashboard-header h1 {
            font-size: 2.2rem;
            margin-bottom: 10px;
        }

    .date-display {
        font-size: 1.1rem;
        opacity: 0.9;
    }

    /* Stats Grid */
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }

    .stat-card {
        background: white;
        border-radius: 12px;
        padding: 25px;
        display: flex;
        align-items: center;
        gap: 20px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        transition: transform 0.2s;
    }

        .stat-card:hover {
            transform: translateY(-5px);
        }

    .streak-card {
        border-left: 4px solid #f59e0b;
    }

    .stat-icon {
        font-size: 2.5rem;
    }

    .stat-content h3 {
        font-size: 2rem;
        color: #1e293b;
        margin-bottom: 5px;
    }

    .stat-content p {
        color: #64748b;
        font-weight: 500;
        margin-bottom: 5px;
    }

    .stat-content small {
        color: #94a3b8;
        font-size: 0.9rem;
    }

    /* Sections */
    .section {
        background: white;
        border-radius: 12px;
        padding: 25px;
        margin-bottom: 25px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    }

    .section-title {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }

    .section h2 {
        color: #1e293b;
        font-size: 1.5rem;
    }

    .btn-primary {
        background: #667eea;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 500;
        transition: background 0.2s;
    }

        .btn-primary:hover {
            background: #5a67d8;
        }

    /* Today's Entry */
    .today-card {
        background: #f8fafc;
        border-radius: 10px;
        padding: 20px;
        border-left: 4px solid #667eea;
    }

    .today-mood {
        font-size: 2rem;
        margin-bottom: 15px;
    }

    .today-preview {
        color: #475569;
        line-height: 1.6;
        margin-bottom: 10px;
        max-height: 100px;
        overflow: hidden;
        position: relative;
    }

        .today-preview::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 20px;
            background: linear-gradient(transparent, #f8fafc);
        }

    .today-time {
        color: #94a3b8;
        font-size: 0.9rem;
    }

    /* Week Grid */
    .week-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
        gap: 15px;
    }

    .day-cell {
        background: #f8fafc;
        border-radius: 8px;
        padding: 15px;
        text-align: center;
        transition: all 0.2s;
    }

        .day-cell.has-entry {
            background: #dcfce7;
            border: 2px solid #22c55e;
        }

        .day-cell.today {
            background: #fef3c7;
            border: 2px solid #f59e0b;
        }

    .day-name {
        font-size: 0.9rem;
        color: #64748b;
        margin-bottom: 5px;
    }

    .day-date {
        font-weight: bold;
        color: #1e293b;
        margin-bottom: 5px;
        font-size: 1.2rem;
    }

    .day-mood {
        font-size: 1.2rem;
        margin-top: 5px;
    }

    /* Recent Entries */
    .view-all {
        color: #667eea;
        text-decoration: none;
        font-weight: 500;
    }

    .recent-list {
        display: flex;
        flex-direction: column;
        gap: 12px;
    }

    .recent-item {
        display: flex;
        align-items: center;
        gap: 15px;
        padding: 15px;
        background: #f8fafc;
        border-radius: 8px;
        transition: background 0.2s;
    }

        .recent-item:hover {
            background: #f1f5f9;
        }

    .recent-date {
        font-weight: bold;
        color: #1e293b;
        min-width: 60px;
    }

    .recent-mood {
        font-size: 1.5rem;
        min-width: 40px;
    }

    .recent-preview {
        flex: 1;
        color: #64748b;
        font-size: 0.95rem;
        line-height: 1.4;
    }

    /* Actions Grid */
    .actions-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 15px;
    }

    .action-btn {
        background: white;
        border: 2px solid #e2e8f0;
        border-radius: 10px;
        padding: 20px;
        cursor: pointer;
        transition: all 0.2s;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 10px;
    }

        .action-btn:hover {
            border-color: #cbd5e1;
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .action-btn span:first-child {
            font-size: 2rem;
        }

        .action-btn span:last-child {
            font-weight: 500;
            color: #475569;
        }

    /* Empty States */
    .empty-state {
        text-align: center;
        padding: 40px 20px;
        color: #64748b;
    }

    .hint {
        color: #f59e0b;
        font-weight: 500;
        margin-top: 10px;
    }

    /* Responsive */
    @@media (max-width: 768px) {
        .dashboard-container {
            padding: 15px;
        }

        .stats-grid {
            grid-template-columns: 1fr;
        }

        .week-grid {
            grid-template-columns: repeat(4, 1fr);
        }

        .actions-grid {
            grid-template-columns: repeat(2, 1fr);
        }

        .dashboard-header h1 {
            font-size: 1.8rem;
        }
    }

    @@media (max-width: 480px) {
        .week-grid {
            grid-template-columns: repeat(2, 1fr);
        }

        .actions-grid {
            grid-template-columns: 1fr;
        }

        .section {
            padding: 20px;
        }
    }
</style>

@code {
    // Data variables
    private int loggedUserId = 0;
    private int totalEntries = 0;
    private int currentStreak = 0;
    private int longestStreak = 0;
    private string averageMood = "🙂";

    // Entry variables
    private JournalEntry? todayEntry = null;
    private bool hasTodayEntry = false;
    private List<JournalEntry> recentEntries = new();
    private List<WeekDay> weekDays = new();

    // Helper class for week days
    private class WeekDay
    {
        public string DayName { get; set; } = "";
        public string Date { get; set; } = "";
        public bool HasEntry { get; set; }
        public string Mood { get; set; } = "";
        public bool IsToday { get; set; }
    }

    protected override async Task OnInitializedAsync()
    {
        // Get logged user ID from localStorage
        var userIdStr = await JS.InvokeAsync<string>("localStorage.getItem", "loggedUserId");
        if (!string.IsNullOrEmpty(userIdStr))
        {
            loggedUserId = int.Parse(userIdStr);
            await LoadDashboardData();
        }
        else
        {
            // Redirect to login if not logged in
            Nav.NavigateTo("/login");
        }
    }

    private async Task LoadDashboardData()
    {
        try
        {
            // Load all entries for this user
            var allEntries = await Task.Run(() =>
                db.JournalEntries
                    .Where(e => e.UserId == loggedUserId)
                    .OrderByDescending(e => e.EntryDate)
                    .ToList());

            // Basic stats
            totalEntries = allEntries.Count;

            // Today's entry
            todayEntry = allEntries.FirstOrDefault(e => e.EntryDate.Date == DateTime.Today);
            hasTodayEntry = todayEntry != null;

            // Recent entries (last 5, excluding today)
            recentEntries = allEntries
                .Where(e => e.EntryDate.Date != DateTime.Today)
                .Take(5)
                .ToList();

            // Calculate streaks DYNAMICALLY
            CalculateStreaks(allEntries);

            // Calculate average mood
            CalculateAverageMood(allEntries);

            // Generate week view
            GenerateWeekView(allEntries);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading dashboard: {ex.Message}");
            // Don't crash - just show empty state
        }
    }

    private void CalculateStreaks(List<JournalEntry> entries)
    {
        if (entries == null || !entries.Any())
        {
            currentStreak = 0;
            longestStreak = 0;
            return;
        }

        try
        {
            // Get all unique dates with entries
            var entryDates = entries
                .Select(e => e.EntryDate.Date)
                .Distinct()
                .OrderByDescending(d => d)
                .ToList();

            // Calculate current streak
            int streak = 0;
            var checkDate = DateTime.Today;

            // Check if today has an entry
            if (entryDates.Contains(DateTime.Today))
            {
                streak = 1;
                checkDate = DateTime.Today.AddDays(-1);

                // Count backwards while we have consecutive entries
                while (entryDates.Contains(checkDate))
                {
                    streak++;
                    checkDate = checkDate.AddDays(-1);
                }
            }
            else
            {
                // Check yesterday
                checkDate = DateTime.Today.AddDays(-1);
                if (entryDates.Contains(checkDate))
                {
                    streak = 1;
                    checkDate = checkDate.AddDays(-1);

                    while (entryDates.Contains(checkDate))
                    {
                        streak++;
                        checkDate = checkDate.AddDays(-1);
                    }
                }
            }

            currentStreak = streak;

            // Calculate longest streak
            longestStreak = FindLongestStreak(entryDates);
        }
        catch
        {
            currentStreak = 0;
            longestStreak = 0;
        }
    }

    private int FindLongestStreak(List<DateTime> dates)
    {
        if (dates == null || !dates.Any()) return 0;

        var sortedDates = dates.OrderBy(d => d).ToList();
        int longest = 1;
        int current = 1;

        for (int i = 1; i < sortedDates.Count; i++)
        {
            var diff = (sortedDates[i] - sortedDates[i - 1]).Days;

            if (diff == 1)
            {
                current++;
                if (current > longest) longest = current;
            }
            else if (diff > 1)
            {
                current = 1;
            }
        }

        return longest;
    }

    private void CalculateAverageMood(List<JournalEntry> entries)
    {
        if (entries == null || !entries.Any())
        {
            averageMood = "🙂";
            return;
        }

        try
        {
            // Simple mood scoring
            var moodCounts = new Dictionary<string, int>
            {
                ["😄"] = 0,
                ["🙂"] = 0,
                ["😐"] = 0,
                ["😔"] = 0,
                ["😢"] = 0
            };

            foreach (var entry in entries)
            {
                if (moodCounts.ContainsKey(entry.PrimaryMood))
                {
                    moodCounts[entry.PrimaryMood]++;
                }
            }

            // Find most common mood
            var mostCommon = moodCounts
                .OrderByDescending(kv => kv.Value)
                .FirstOrDefault();

            averageMood = mostCommon.Key ?? "🙂";
        }
        catch
        {
            averageMood = "🙂";
        }
    }

    private void GenerateWeekView(List<JournalEntry> entries)
    {
        weekDays.Clear();

        // Get last 7 days including today
        for (int i = 6; i >= 0; i--)
        {
            var date = DateTime.Today.AddDays(-i);
            var entry = entries?.FirstOrDefault(e => e.EntryDate.Date == date.Date);

            weekDays.Add(new WeekDay
            {
                DayName = date.ToString("ddd"),
                Date = date.Day.ToString(),
                HasEntry = entry != null,
                Mood = entry?.PrimaryMood ?? "",
                IsToday = date.Date == DateTime.Today.Date
            });
        }
    }

    private string GetPreview(string content)
    {
        if (string.IsNullOrEmpty(content)) return "";

        try
        {
            // Remove HTML tags
            var plainText = System.Text.RegularExpressions.Regex.Replace(content, "<.*?>", " ");

            // Limit length
            if (plainText.Length > 150)
                return plainText.Substring(0, 150) + "...";

            return plainText;
        }
        catch
        {
            return "";
        }
    }

    private string GetShortPreview(string content)
    {
        if (string.IsNullOrEmpty(content)) return "";

        try
        {
            var plainText = System.Text.RegularExpressions.Regex.Replace(content, "<.*?>", " ");

            if (plainText.Length > 60)
                return plainText.Substring(0, 60) + "...";

            return plainText;
        }
        catch
        {
            return "";
        }
    }

    // Navigation methods
    private void GoToJournal()
    {
        Nav.NavigateTo("/entry");
    }

    private void GoToCalendar()
    {
        Nav.NavigateTo("/calendar");
    }

    private void GoToTimeline()
    {
        Nav.NavigateTo("/timeline");
    }
}