@page "/timeline"
@using BrainDumpster.Data
@using BrainDumpster.Model
@inject AppDbContext db
@inject IJSRuntime JS

<PageTitle>Timeline - BrainDumpster</PageTitle>

<div class="container mt-4">
    <h1 class="text-center mb-4">⏳ Journal Timeline</h1>

    <!-- Search Filter -->
    <div class="card p-3 mb-4">
        <div class="row">
            <div class="col-md-12 mb-3">
                <label class="form-label">Search entries:</label>
                <input type="text" class="form-control" placeholder="Search by content..."
                       @bind="searchQuery" @bind:event="oninput" />
            </div>
        </div>
    </div>

    <!-- Simple Filter -->
    <div class="card p-3 mb-4">
        <div class="row">
            <div class="col-md-6 mb-3">
                <label class="form-label">Show entries from:</label>
                <select class="form-select" @onchange="HandleDateChange">
                    <option value="7">Last 7 Days</option>
                    <option value="30" selected>Last 30 Days</option>
                    <option value="90">Last 90 Days</option>
                    <option value="0">All Time</option>
                </select>
            </div>

            <div class="col-md-6 mb-3">
                <label class="form-label">Mood:</label>
                <select class="form-select" @onchange="HandleMoodChange">
                    <option value="">All Moods</option>
                    <option value="😄">😄 Happy</option>
                    <option value="🙂">🙂 Smiling</option>
                    <option value="😐">😐 Neutral</option>
                    <option value="😔">😔 Sad</option>
                </select>
            </div>
        </div>
    </div>

    <!-- Timeline -->
    @if (isLoading)
    {
        <div class="text-center my-5">
            <div class="spinner-border text-primary"></div>
            <p class="mt-2">Loading your timeline...</p>
        </div>
    }
    else if (entries.Any())
    {
        <div class="timeline-simple">
            @foreach (var entry in entries)
            {
                <div class="timeline-card mb-4">
                    <div class="timeline-date">
                        <div class="date-day">@entry.EntryDate.ToString("dd")</div>
                        <div class="date-month">@entry.EntryDate.ToString("MMM")</div>
                        <div class="date-year">@entry.EntryDate.ToString("yyyy")</div>
                    </div>

                    <div class="timeline-content">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <h5>@entry.EntryDate.ToString("dddd")</h5>
                                <small class="text-muted">@entry.EntryDate.ToString("h:mm tt")</small>
                            </div>
                            <span class="mood-display">@entry.PrimaryMood</span>
                        </div>

                        <div class="entry-text mt-3">
                            @((MarkupString)GetPreview(entry.Content))
                        </div>

                        <div class="mt-3">
                            <button class="btn btn-sm btn-outline-primary" @onclick="@(() => ShowEntry(entry.Id))">
                                View Full Entry
                            </button>
                        </div>
                    </div>
                </div>
            }
        </div>
    }
    else
    {
        <div class="text-center my-5">
            <div class="alert alert-info">
                <h4>📝 No journal entries found</h4>
                <p class="mb-3">Start writing to build your timeline!</p>
                <a href="/entry" class="btn btn-primary">Write Your First Entry</a>
            </div>
        </div>
    }
</div>

<!-- Simple Modal -->
@if (showModal && selectedEntry != null)
{
    <div class="modal-backdrop" @onclick="CloseModal"></div>
    <div class="modal-simple">
        <div class="modal-header">
            <h5>
                @selectedEntry.EntryDate.ToString("MMMM d, yyyy")
                <span class="ms-2">@selectedEntry.PrimaryMood</span>
            </h5>
            <button class="btn-close" @onclick="CloseModal"></button>
        </div>
        <div class="modal-body">
            <div class="full-content">
                @((MarkupString)selectedEntry.Content)
            </div>

            <div class="mt-4 p-3 bg-light">
                <h6>📊 Entry Stats</h6>
                <div class="row mt-2">
                    <div class="col-4 text-center">
                        <div class="stat-num">@CountWords(selectedEntry.Content)</div>
                        <small>Words</small>
                    </div>
                    <div class="col-4 text-center">
                        <div class="stat-num">@CalculateReadingTime(selectedEntry.Content)</div>
                        <small>Min Read</small>
                    </div>
                    <div class="col-4 text-center">
                        <div class="stat-num">@selectedEntry.Content.Length</div>
                        <small>Characters</small>
                    </div>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" @onclick="CloseModal">Close</button>
        </div>
    </div>
}

@code {
    private List<JournalEntry> entries = new();
    private JournalEntry? selectedEntry = null;
    private bool showModal = false;
    private bool isLoading = false;
    private int loggedUserId = 0;

    // Filters
    private string dateFilter = "30";
    private string moodFilter = "";

    // Search property with LoadTimeline trigger
    private string _searchQuery = "";
    private string searchQuery
    {
        get => _searchQuery;
        set
        {
            _searchQuery = value;
            _ = LoadTimeline(); // reload timeline whenever user types
        }
    }

    protected override async Task OnInitializedAsync()
    {
        try
        {
            // Get logged user ID
            var userIdStr = await JS.InvokeAsync<string>("localStorage.getItem", "loggedUserId");
            if (!string.IsNullOrEmpty(userIdStr))
            {
                loggedUserId = int.Parse(userIdStr);
                await LoadTimeline();
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error: {ex.Message}");
        }
    }

    private async Task LoadTimeline()
    {
        if (loggedUserId == 0) return;

        try
        {
            isLoading = true;
            StateHasChanged(); // Show loading spinner

            // Calculate date range
            DateTime? startDate = null;
            if (dateFilter != "0" && int.TryParse(dateFilter, out int days))
            {
                startDate = DateTime.Now.AddDays(-days);
            }

            // Get entries
            var query = db.JournalEntries
                .Where(e => e.UserId == loggedUserId);

            if (startDate.HasValue)
                query = query.Where(e => e.EntryDate >= startDate.Value);

            if (!string.IsNullOrEmpty(moodFilter))
                query = query.Where(e => e.PrimaryMood == moodFilter);

            if (!string.IsNullOrWhiteSpace(searchQuery))
                query = query.Where(e => e.Content.Contains(searchQuery));

            entries = await Task.Run(() =>
                query
                    .OrderByDescending(e => e.EntryDate)
                    .Take(100)
                    .ToList()
            );
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading timeline: {ex.Message}");
            entries = new List<JournalEntry>();
        }
        finally
        {
            isLoading = false;
            StateHasChanged(); // Hide loading spinner
        }
    }

    private async void HandleDateChange(ChangeEventArgs e)
    {
        dateFilter = e.Value?.ToString() ?? "30";
        await LoadTimeline();
    }

    private async void HandleMoodChange(ChangeEventArgs e)
    {
        moodFilter = e.Value?.ToString() ?? "";
        await LoadTimeline();
    }

    private string GetPreview(string content)
    {
        if (string.IsNullOrEmpty(content)) return "";
        var plainText = System.Text.RegularExpressions.Regex.Replace(content, "<.*?>", " ");
        plainText = System.Net.WebUtility.HtmlDecode(plainText);
        plainText = plainText.Trim();
        return plainText.Length > 250 ? plainText.Substring(0, 250) + "..." : plainText;
    }

    private int CountWords(string content)
    {
        if (string.IsNullOrWhiteSpace(content)) return 0;
        var text = System.Text.RegularExpressions.Regex.Replace(content, "<.*?>", " ");
        text = System.Net.WebUtility.HtmlDecode(text);
        return text.Split(new[] { ' ', '\n', '\r', '\t' }, StringSplitOptions.RemoveEmptyEntries).Length;
    }

    private int CalculateReadingTime(string content)
    {
        var wordCount = CountWords(content);
        var minutes = (int)Math.Ceiling(wordCount / 200.0);
        return Math.Max(1, minutes);
    }

    private async Task ShowEntry(int entryId)
    {
        try
        {
            selectedEntry = await Task.Run(() =>
                db.JournalEntries.FirstOrDefault(e => e.Id == entryId));

            if (selectedEntry != null)
            {
                showModal = true;
                StateHasChanged();
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error showing entry: {ex.Message}");
        }
    }

    private void CloseModal()
    {
        showModal = false;
        selectedEntry = null;
        StateHasChanged();
    }
}
